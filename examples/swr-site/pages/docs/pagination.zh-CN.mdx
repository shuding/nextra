import { Callout } from 'nextra-theme-docs'

# åˆ†é¡µ

<Callout emoji="âœ…">
  è¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ (â‰¥ 0.3.0) æ¥ç”¨æ­¤ APIã€‚åŸæ¥çš„ <code>useSWRPages</code> API å·²åºŸå¼ƒã€‚
</Callout>

SWR æä¾›äº†ä¸€ä¸ªä¸“ç”¨ API `useSWRInfinite` æ¥æ”¯æŒå¸¸è§çš„ UI æ¨¡å¼ï¼Œæ¯”å¦‚ **åˆ†é¡µ** å’Œ **æ— é™åŠ è½½**ã€‚

## ä½•æ—¶åº”è¯¥ç»§ç»­ä½¿ç”¨ `useSWR`

### åˆ†é¡µ

é¦–å…ˆï¼Œæˆ‘ä»¬å¯èƒ½ **å¹¶ä¸** éœ€è¦ `useSWRInfinite`ï¼Œå¦‚æœæˆ‘ä»¬æ­£åœ¨æ„å»ºå¦‚ä¸‹å†…å®¹ï¼Œå¯ä»¥åªä½¿ç”¨ `useSWR`ï¼š

import { Pagination } from '@components/diagrams/pagination'

<div className="mt-8">
  <Pagination/>
</div>

...è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†é¡µ UIã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ç”¨ `useSWR` è½»æ¾å®ç°å®ƒï¼š

```jsx {5}
function App () {
  const [pageIndex, setPageIndex] = useState(0);

  // API URL åŒ…æ‹¬é¡µé¢ç´¢å¼•ï¼Œå®ƒæ˜¯ä¸€ä¸ª React stateã€‚
  const { data } = useSWR(`/api/data?page=${pageIndex}`, fetcher);

  // ... å¤„ç†åŠ è½½å’Œé”™è¯¯çŠ¶æ€

  return <div>
    {data.map(item => <div key={item.id}>{item.name}</div>)}
    <button onClick={() => setPageIndex(pageIndex - 1)}>Previous</button>
    <button onClick={() => setPageIndex(pageIndex + 1)}>Next</button>
  </div>
}
```

æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¿™ä¸ª "page ç»„ä»¶" åˆ›å»ºä¸€ä¸ªæŠ½è±¡ï¼š

```jsx {13}
function Page ({ index }) {
  const { data } = useSWR(`/api/data?page=${index}`, fetcher);

  // ... å¤„ç†åŠ è½½å’Œé”™è¯¯çŠ¶æ€

  return data.map(item => <div key={item.id}>{item.name}</div>)
}

function App () {
  const [pageIndex, setPageIndex] = useState(0);

  return <div>
    <Page index={pageIndex}/>
    <button onClick={() => setPageIndex(pageIndex - 1)}>Previous</button>
    <button onClick={() => setPageIndex(pageIndex + 1)}>Next</button>
  </div>
}
```

SWR çš„ç¼“å­˜ä¼šè®©æˆ‘ä»¬åœ¨é¢„å…ˆåŠ è½½ä¸‹ä¸€é¡µæ–¹é¢å—ç›ŠåŒªæµ…ã€‚æˆ‘ä»¬åœ¨ä¸€ä¸ª hidden çš„ div ä¸­æ¸²æŸ“ä¸‹ä¸€é¡µï¼Œæ‰€ä»¥ SWR å°†è§¦å‘å¯¹ä¸‹ä¸€é¡µçš„æ•°æ®è¯·æ±‚ã€‚å½“ç”¨æˆ·å¯¼èˆªåˆ°ä¸‹ä¸€é¡µæ—¶ï¼Œæ•°æ®å·²ç»åŠ è½½å¥½äº†ï¼š

```jsx {6}
function App () {
  const [pageIndex, setPageIndex] = useState(0);

  return <div>
    <Page index={pageIndex}/>
    <div style={{ display: 'none' }}><Page index={pageIndex + 1}/></div>
    <button onClick={() => setPageIndex(pageIndex - 1)}>Previous</button>
    <button onClick={() => setPageIndex(pageIndex + 1)}>Next</button>
  </div>
}
```

ä»…ç”¨ä¸€è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±è·å¾—äº†éå¸¸å¥½çš„ç”¨æˆ·ä½“éªŒã€‚`useSWR` hook éå¸¸å¼ºå¤§ï¼Œå®ƒæ¶µç›–äº†å¤§å¤šæ•°åœºæ™¯ã€‚

### æ— é™åŠ è½½

æœ‰æ—¶æˆ‘ä»¬æƒ³æ„å»ºä¸€ä¸ª**æ— é™åŠ è½½** UIï¼Œç”¨ä¸€ä¸ª "Load More" æŒ‰é’®å‘åˆ—è¡¨è¿½åŠ æ•°æ®ï¼ˆæˆ–è€…åœ¨æ»šåŠ¨æ—¶è‡ªåŠ¨å®Œæˆï¼‰ï¼š

import { Infinite } from '@components/diagrams/infinite'

<div className="mt-8">
  <Infinite/>
</div>

è¦å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªé¡µé¢ **åŠ¨æ€ç”Ÿæˆè¯·æ±‚æ•°**ã€‚React Hooks æœ‰ [2 ä¸ªè§„åˆ™](https://reactjs.org/docs/hooks-rules.html)ï¼Œæ‰€ä»¥æˆ‘ä»¬ **ä¸èƒ½** å†™ä¸‹é¢çš„ä»£ç ï¼š

```jsx {5-9}
function App () {
  const [cnt, setCnt] = useState(1)

  const list = []
  for (let i = 0; i < cnt; i++) {
    // ğŸš¨ å‡ºé”™äº†ï¼é€šå¸¸æ¥è¯´ï¼Œä½ ä¸èƒ½åœ¨å¾ªç¯é‡Œä½¿ç”¨ hooksã€‚
    const { data } = useSWR(`/api/data?page=${i}`)
    list.push(data)
  }

  return <div>
    {list.map((data, i) =>
      <div key={i}>{
        data.map(item => <div key={item.id}>{item.name}</div>)
      }</div>)}
    <button onClick={() => setCnt(cnt + 1)}>Load More</button>
  </div>
}
```

ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ›å»ºçš„ `<Page />` æŠ½è±¡æ¥å®ç°å®ƒï¼š

```jsx {5-7}
function App () {
  const [cnt, setCnt] = useState(1)

  const pages = []
  for (let i = 0; i < cnt; i++) {
    pages.push(<Page index={i} key={i} />)
  }

  return <div>
    {pages}
    <button onClick={() => setCnt(cnt + 1)}>Load More</button>
  </div>
}
```

### é«˜çº§ç”¨ä¾‹

ä½†æ˜¯ï¼Œåœ¨æŸäº›é«˜çº§ç”¨ä¾‹ä¸­ï¼Œä¸Šé¢çš„è§£å†³æ–¹æ¡ˆå¹¶ä¸èµ·ä½œç”¨ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬ä»ç„¶å®ç°ç›¸åŒçš„ "Load More" UIï¼Œä½†è¿˜éœ€è¦æ˜¾ç¤ºä¸€ä¸ª item æ€»æ•°çš„æ•°å­—ã€‚æˆ‘ä»¬ä¸èƒ½å†ä½¿ç”¨ `<Page />` è¿™ä¸ªè§£å†³æ–¹æ¡ˆäº†ï¼Œå› ä¸ºé¡¶çº§ UI (`<App />`) éœ€è¦æ¯ä¸ªé¡µé¢çš„æ•°æ®ï¼š

```jsx {10}
function App () {
  const [cnt, setCnt] = useState(1)

  const pages = []
  for (let i = 0; i < cnt; i++) {
    pages.push(<Page index={i} key={i} />)
  }

  return <div>
    <p>??? items</p>
    {pages}
    <button onClick={() => setCnt(cnt + 1)}>Load More</button>
  </div>
}
```

å¦å¤–ï¼Œå¦‚æœåˆ†é¡µ API æ˜¯ **åŸºäºæ¸¸æ ‡çš„**ï¼Œé‚£ä¹ˆè¿™ä¸ªè§£å†³æ–¹æ¡ˆä¹Ÿä¸èµ·ä½œç”¨ã€‚å› ä¸ºæ¯ä¸ªé¡µé¢éƒ½éœ€è¦ä¸Šä¸€é¡µçš„æ•°æ®ï¼Œå®ƒä»¬ä¸æ˜¯å­¤ç«‹çš„ã€‚

è¿™å°±æ˜¯è¿™ä¸ªæ–° `useSWRInfinite` Hook çš„ä½œç”¨ã€‚

## useSWRInfinite

`useSWRInfinite` è®©æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ä¸€ä¸ª Hook è§¦å‘å¤šä¸ªè¯·æ±‚ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š

```jsx
import useSWRInfinite from 'swr/infinite'

// ...
const { data, error, isValidating, mutate, size, setSize } = useSWRInfinite(
  getKey, fetcher?, options?
)
```

å’Œ `useSWR` ç±»ä¼¼ï¼Œè¿™ä¸ªæ–°çš„ Hook æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›è¯·æ±‚çš„ keyã€1 ä¸ª fetcher å‡½æ•°å’Œ optionsã€‚å®ƒè¿”å› `useSWR` çš„æ‰€æœ‰è¿”å›å€¼ï¼Œè¿˜åŒ…æ‹¬ 2 ä¸ªé¢å¤–çš„å€¼ï¼špage size å’Œ page size setterï¼Œç±»ä¼¼ä¸€ä¸ª React stateã€‚

åœ¨æ— é™åŠ è½½ä¸­ï¼Œä¸€ä¸ª _é¡µé¢_ æ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è¯·æ±‚å¤šé¡µé¢å¹¶æ¸²æŸ“å®ƒä»¬ã€‚

<Callout emoji="âš ï¸">
  å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ SWR 0.x ç‰ˆæœ¬ï¼Œåˆ™éœ€è¦ä» `swr` å¯¼å…¥ `useSWRInfinite`ï¼š<br/>
  `import { useSWRInfinite } from 'swr'`
</Callout>

### API

#### å‚æ•°

- `getKey`: ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ç´¢å¼•å’Œä¸Šä¸€é¡µæ•°æ®ï¼Œè¿”å›é¡µé¢çš„ key
- `fetcher`: å’Œ `useSWR` çš„ [fetcher å‡½æ•°](/docs/data-fetching) ä¸€æ ·
- `options`: æ¥å— `useSWR` æ”¯æŒçš„æ‰€æœ‰é€‰é¡¹ï¼Œä»¥åŠ 3 ä¸ªé¢å¤–é€‰é¡¹ï¼š
  - `initialSize = 1`: æœ€åˆåº”åŠ è½½çš„é¡µé¢æ•°é‡
  - `revalidateAll = false`: å§‹ç»ˆå°è¯•é‡æ–°éªŒè¯æ‰€æœ‰é¡µé¢
  - `revalidateFirstPage = true`: å§‹ç»ˆå°è¯•é‡æ–°éªŒè¯ç¬¬ä¸€é¡µ
  - `persistSize = false`: å½“ç¬¬ä¸€é¡µçš„ key å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸å°† page sizeï¼ˆæˆ–è€… `initialSize` å¦‚æœè®¾ç½®äº†è¯¥å‚æ•°ï¼‰é‡ç½®ä¸º 1

<Callout>
  è¯·æ³¨æ„ï¼Œ`initialSize` é€‰é¡¹å¹¶ä¸æ”¯æŒåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å‘ç”Ÿæ”¹å˜ã€‚
</Callout>

#### è¿”å›å€¼

- `data`: ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªé¡µé¢è¯·æ±‚çš„å“åº”å€¼
- `error`: ä¸ `useSWR` çš„ `error` è¿”å›å€¼ç›¸åŒ
- `isValidating`: ä¸ `useSWR` çš„ `isValidating` è¿”å›å€¼ç›¸åŒ
- `mutate`: å’Œ `useSWR` çš„ç»‘å®š mutate å‡½æ•°ä¸€æ ·ï¼Œä½†æ˜¯æ“ä½œ data æ•°ç»„
- `size`: *å³å°†*è¯·æ±‚å’Œè¿”å›çš„é¡µé¢æ•°
- `setSize`: è®¾ç½®éœ€è¦è¯·æ±‚çš„é¡µé¢æ•°

### ç¤ºä¾‹ 1ï¼šåŸºäºç´¢å¼•çš„åˆ†é¡µ API

æ™®é€šçš„åŸºäºç´¢å¼•çš„ APIï¼š

```
GET /users?page=0&limit=10
[
  { name: 'Alice', ... },
  { name: 'Bob', ... },
  { name: 'Cathy', ... },
  ...
]
```

```jsx {4-7,10}
// ä¸€ä¸ªå‡½æ•°ï¼Œæ‹¿åˆ°æ¯ä¸ªé¡µé¢çš„ keyï¼Œ
// `fetcher` æ¥å—å®ƒçš„è¿”å›å€¼ã€‚
// å¦‚æœè¿”å›æ˜¯ `null`ï¼Œè¯¥é¡µé¢ä¸ä¼šå¼€å§‹è¯·æ±‚ã€‚
const getKey = (pageIndex, previousPageData) => {
  if (previousPageData && !previousPageData.length) return null // reached the end
  return `/users?page=${pageIndex}&limit=10`                    // SWR key
}

function App () {
  const { data, size, setSize } = useSWRInfinite(getKey, fetcher)
  if (!data) return 'loading'

  // æˆ‘ä»¬ç°åœ¨å¯ä»¥è®¡ç®—å‡ºæ‰€æœ‰ç”¨æˆ·çš„æ•°é‡
  let totalUsers = 0
  for (let i = 0; i < data.length; i++) {
    totalUsers += data[i].length
  }

  return <div>
    <p>{totalUsers} users listed</p>
    {data.map((users, index) => {
      // `data` æ˜¯æ¯ä¸ªé¡µé¢ API å“åº”çš„æ•°ç»„ã€‚
      return users.map(user => <div key={user.id}>{user.name}</div>)
    })}
    <button onClick={() => setSize(size + 1)}>Load More</button>
  </div>
}
```

`getKey` å‡½æ•°æ˜¯ `useSWRInfinite` å’Œ `useSWR` ä¹‹é—´çš„ä¸»è¦åŒºåˆ«ã€‚å®ƒæ¥å—å½“å‰é¡µçš„ç´¢å¼•ä»¥åŠä¸Šä¸€é¡µçš„æ•°æ®ã€‚å› æ­¤å¯ä»¥å¾ˆå¥½åœ°æ”¯æŒåŸºäºç´¢å¼•å’ŒåŸºäºæ¸¸æ ‡çš„åˆ†é¡µ APIã€‚

æ­¤å¤–ï¼Œ`data` ä¸å†åªæ˜¯ä¸€ä¸ª API å“åº”ã€‚å®ƒæ˜¯å¤šä¸ª API å“åº”çš„æ•°ç»„ï¼š

```js
// `data` å°†å¦‚ä¸‹æ‰€ç¤º
[
  [
    { name: 'Alice', ... },
    { name: 'Bob', ... },
    { name: 'Cathy', ... },
    ...
  ],
  [
    { name: 'John', ... },
    { name: 'Paul', ... },
    { name: 'George', ... },
    ...
  ],
  ...
]
```

### ç¤ºä¾‹ 2ï¼šåŸºäºæ¸¸æ ‡æˆ–åç§»çš„åˆ†é¡µ API

å‡è®¾ç°åœ¨ API éœ€è¦ä¸€ä¸ªæ¸¸æ ‡ï¼Œå¹¶å°†ä¸‹ä¸€ä¸ªæ¸¸æ ‡å’Œæ•°æ®ä¸€èµ·è¿”å›ï¼š

```plaintext
GET /users?cursor=123&limit=10
{
  data: [
    { name: 'Alice' },
    { name: 'Bob' },
    { name: 'Cathy' },
    ...
  ],
  nextCursor: 456
}
```

æˆ‘ä»¬å¯ä»¥å°† `getKey` å‡½æ•°æ”¹ä¸ºä¸‹é¢è¿™æ ·ï¼š

```jsx
const getKey = (pageIndex, previousPageData) => {
  // reached the end
  if (previousPageData && !previousPageData.data) return null

  // é¦–é¡µï¼Œæ²¡æœ‰ `previousPageData`
  if (pageIndex === 0) return `/users?limit=10`

  // å°†æ¸¸æ ‡æ·»åŠ åˆ° API
  return `/users?cursor=${previousPageData.nextCursor}&limit=10`
}
```

### é«˜çº§ç‰¹æ€§

[è¿™é‡Œæœ‰ä¸€ä¸ªç¤ºä¾‹](/examples/infinite-loading) æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ `useSWRInfinite` å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

- åŠ è½½çŠ¶æ€
- å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºä¸€ä¸ªç‰¹æ®Šçš„ UI
- å¦‚æœ reached the endï¼Œç¦ç”¨ "Load More" æŒ‰é’®
- æ•°æ®æºå¯å˜
- åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
